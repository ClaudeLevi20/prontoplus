name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request:
    types: [closed]

jobs:
  deploy-preview:
    name: Deploy Preview Environment
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    environment: preview
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build

      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Login to Railway
        run: railway login --token ${{ secrets.RAILWAY_TOKEN }}

      - name: Create preview environment
        id: create-env
        run: |
          # Create a unique environment name for this PR
          ENV_NAME="pr-${{ github.event.number }}"
          
          # Create new Railway environment
          railway environment create --name "$ENV_NAME" --project ${{ secrets.RAILWAY_API_PROJECT_ID }}
          
          echo "environment_name=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "Created environment: $ENV_NAME"

      - name: Deploy API to preview
        run: |
          railway link ${{ secrets.RAILWAY_API_PROJECT_ID }}
          railway environment use ${{ steps.create-env.outputs.environment_name }}
          railway up --service api
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Deploy Frontend to preview
        run: |
          railway link ${{ secrets.RAILWAY_FRONTEND_PROJECT_ID }}
          railway environment use ${{ steps.create-env.outputs.environment_name }}
          railway up --service frontend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Wait for deployments
        run: sleep 60

      - name: Get preview URLs
        id: get-urls
        run: |
          # Get API URL
          API_URL=$(railway status --json | jq -r '.deployments[] | select(.service == "api") | .url' | head -1)
          
          # Get Frontend URL
          FRONTEND_URL=$(railway status --json | jq -r '.deployments[] | select(.service == "frontend") | .url' | head -1)
          
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          
          echo "API URL: $API_URL"
          echo "Frontend URL: $FRONTEND_URL"

      - name: Run smoke tests on preview
        run: |
          API_URL="${{ steps.get-urls.outputs.api_url }}"
          FRONTEND_URL="${{ steps.get-urls.outputs.frontend_url }}"
          
          # Test API health
          echo "Testing API health..."
          curl -f "$API_URL/health" || exit 1
          
          # Test frontend
          echo "Testing frontend..."
          curl -f "$FRONTEND_URL" || exit 1
          
          echo "âœ… Preview environment is healthy!"

      - name: Comment preview URLs
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('## ðŸš€ Preview Environment')
            );
            
            const body = `## ðŸš€ Preview Environment
            
            Your changes have been deployed to a preview environment:
            
            **ðŸŒ Frontend:** [${{ steps.get-urls.outputs.frontend_url }}](${{ steps.get-urls.outputs.frontend_url }})
            **ðŸ”§ API:** [${{ steps.get-urls.outputs.api_url }}](${{ steps.get-urls.outputs.api_url }})
            
            **API Health Check:** [${{ steps.get-urls.outputs.api_url }}/health](${{ steps.get-urls.outputs.api_url }}/health)
            **API Documentation:** [${{ steps.get-urls.outputs.api_url }}/api/docs](${{ steps.get-urls.outputs.api_url }}/api/docs)
            
            ---
            *This preview environment will be automatically deleted when the PR is closed or merged.*`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  cleanup-preview:
    name: Cleanup Preview Environment
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    environment: preview
    steps:
      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Login to Railway
        run: railway login --token ${{ secrets.RAILWAY_TOKEN }}

      - name: Delete preview environment
        run: |
          ENV_NAME="pr-${{ github.event.number }}"
          echo "Deleting environment: $ENV_NAME"
          
          # Try to delete the environment (ignore errors if it doesn't exist)
          railway environment delete --name "$ENV_NAME" --project ${{ secrets.RAILWAY_API_PROJECT_ID }} || true
          railway environment delete --name "$ENV_NAME" --project ${{ secrets.RAILWAY_FRONTEND_PROJECT_ID }} || true
          
          echo "âœ… Preview environment cleanup completed"

      - name: Comment cleanup status
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ðŸ§¹ Preview Environment Cleanup
            
            The preview environment for this PR has been automatically deleted.
            
            **Environment:** pr-${{ github.event.number }}
            **Status:** âœ… Cleaned up successfully`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
